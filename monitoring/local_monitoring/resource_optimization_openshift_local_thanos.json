{
  "apiVersion": "recommender.com/v1",
  "kind": "KruizePerformanceProfile",
  "metadata": {
    "name": "resource-optimization-local-monitoring-thanos"
  },
  "profile_version": 1,
  "k8s_type": "openshift",
  "slo": {
    "slo_class": "resource_usage",
    "direction": "minimize",
    "objective_function": {
      "function_type": "source"
    },
    "function_variables": [
      {
        "name": "cpuRequest",
        "datasource": "prometheus",
        "value_type": "double",
        "kubernetes_object": "container",
        "aggregation_functions": [
          {
            "function": "avg",
            "query": "avg by(container, namespace) (kube_pod_container_resource_requests{container!='', container!='POD' , resource='cpu', unit='core' ,namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"} * on(pod, namespace) group_left max by (container, pod, namespace) (kube_pod_status_phase{phase='Running'}))"
          },
          {
            "function": "sum",
            "query": "sum by(container, namespace) (kube_pod_container_resource_requests{container!='', container!='POD', resource='cpu', unit='core' ,namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"} * on(pod, namespace) group_left max by (container, pod, namespace) (kube_pod_status_phase{phase='Running'}))"
          },
          {
            "function": "min",
            "query": "min by(container, namespace) (kube_pod_container_resource_requests{container!='', container!='POD', resource='cpu', unit='core' ,namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"} * on(pod, namespace) group_left max by (container, pod, namespace) (kube_pod_status_phase{phase='Running'}))"
          },
          {
            "function": "max",
            "query": "max by(container, namespace) (kube_pod_container_resource_requests{container!='', container!='POD', resource='cpu', unit='core' ,namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"} * on(pod, namespace) group_left max by (container, pod, namespace) (kube_pod_status_phase{phase='Running'}))"
          }
        ]
      },
      {
        "name": "cpuLimit",
        "datasource": "prometheus",
        "value_type": "double",
        "kubernetes_object": "container",
        "aggregation_functions": [
          {
            "function": "avg",
            "query": "avg by(container,namespace) (kube_pod_container_resource_limits{container!='', container!='POD', resource='cpu', unit='core',namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"} * on(pod, namespace) group_left max by (container,pod, namespace) (kube_pod_status_phase{phase='Running'}))"
          },
          {
            "function": "sum",
            "query": "sum by(container,namespace) (kube_pod_container_resource_limits{container!='', container!='POD', resource='cpu', unit='core',namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"} * on(pod, namespace) group_left max by (container,pod, namespace) (kube_pod_status_phase{phase='Running'}))"
          },
          {
            "function": "max",
            "query": "max by(container,namespace) (kube_pod_container_resource_limits{container!='', container!='POD', resource='cpu', unit='core',namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"} * on(pod, namespace) group_left max by (container,pod, namespace) (kube_pod_status_phase{phase='Running'}))"
          },
          {
            "function": "min",
            "query": "min by(container,namespace) (kube_pod_container_resource_limits{container!='', container!='POD', resource='cpu', unit='core',namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"} * on(pod, namespace) group_left max by (container,pod, namespace) (kube_pod_status_phase{phase='Running'}))"
          }
        ]
      },
      {
        "name": "cpuUsage",
        "datasource": "prometheus",
        "value_type": "double",
        "kubernetes_object": "container",
        "aggregation_functions": [
          {
            "function": "avg",
            "query":"avg by(container, namespace) (avg_over_time((irate(container_cpu_usage_seconds_total{container!='', container!='POD',namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"}[5m]))[1d:]))"

          },
          {
            "function": "min",
            "query": "min by(container, namespace) (min_over_time((irate(container_cpu_usage_seconds_total{container!='', container!='POD',namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"}[5m]))[1d:]))"

          },
          {
            "function": "max",
            "query": "max by(container, namespace) (max_over_time((irate(container_cpu_usage_seconds_total{container!='', container!='POD',namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"}[5m]))[1d:]))"

          },
          {
            "function": "sum",
            "query": "sum by(container, namespace) (avg_over_time((irate(container_cpu_usage_seconds_total{container!='', container!='POD',namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"}[5m]))[1d:]))"
          }
        ]
      },
      {
        "name": "cpuThrottle",
        "datasource": "prometheus",
        "value_type": "double",
        "kubernetes_object": "container",
        "aggregation_functions": [
          {
            "function": "avg",
            "query": "avg by(container,namespace) (rate(container_cpu_cfs_throttled_seconds_total{container!='', container!='POD',namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"}[1d]))"
          },
          {
            "function": "max",
            "query": "max by(container,namespace) (rate(container_cpu_cfs_throttled_seconds_total{container!='', container!='POD',namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"}[1d]))"
          },
          {
            "function": "min",
            "query": "min by(container,namespace) (rate(container_cpu_cfs_throttled_seconds_total{container!='', container!='POD',namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"}[1d]))"
          },
          {
            "function": "sum",
            "query": "sum by(container,namespace) (rate(container_cpu_cfs_throttled_seconds_total{container!='', container!='POD',namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"}[1d]))"
          }
        ]
      },
      {
        "name": "memoryRequest",
        "datasource": "prometheus",
        "value_type": "double",
        "kubernetes_object": "container",
        "aggregation_functions": [
          {
            "function": "avg",
            "query": "avg by(container, namespace) (kube_pod_container_resource_requests{container!='', container!='POD', resource='memory', unit='byte' ,namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"} * on(pod, namespace) group_left max by (container, pod, namespace) (kube_pod_status_phase{phase='Running'}))"
          },
          {
            "function": "sum",
            "query": "sum by(container, namespace) (kube_pod_container_resource_requests{container!='', container!='POD', resource='memory', unit='byte' ,namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"} * on(pod, namespace) group_left max by (container, pod, namespace) (kube_pod_status_phase{phase='Running'}))"
          },
          {
            "function": "max",
            "query": "max by(container, namespace) (kube_pod_container_resource_requests{container!='', container!='POD', resource='memory', unit='byte' ,namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"} * on(pod, namespace) group_left max by (container, pod, namespace) (kube_pod_status_phase{phase='Running'}))"
          },
          {
            "function": "min",
            "query": "min by(container, namespace) (kube_pod_container_resource_requests{container!='', container!='POD', resource='memory', unit='byte' ,namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"} * on(pod, namespace) group_left max by (container, pod, namespace) (kube_pod_status_phase{phase='Running'}))"
          }
        ]
      },
      {
        "name": "memoryLimit",
        "datasource": "prometheus",
        "value_type": "double",
        "kubernetes_object": "container",
        "aggregation_functions": [
          {
            "function": "avg",
            "query": "avg by(container,namespace) (kube_pod_container_resource_limits{container!='', container!='POD', resource='memory', unit='byte',namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"} * on(pod, namespace) group_left max by (container,pod, namespace) (kube_pod_status_phase{phase='Running'}))"
          },
          {
            "function": "sum",
            "query": "sum by(container,namespace) (kube_pod_container_resource_limits{container!='', container!='POD', resource='memory', unit='byte',namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"} * on(pod, namespace) group_left max by (container,pod, namespace) (kube_pod_status_phase{phase='Running'}))"
          },
          {
            "function": "max",
            "query": "max by(container,namespace) (kube_pod_container_resource_limits{container!='', container!='POD', resource='memory', unit='byte',namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"} * on(pod, namespace) group_left max by (container,pod, namespace) (kube_pod_status_phase{phase='Running'}))"
          },
          {
            "function": "min",
            "query": "min by(container,namespace) (kube_pod_container_resource_limits{container!='', container!='POD', resource='memory', unit='byte',namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"} * on(pod, namespace) group_left max by (container,pod, namespace) (kube_pod_status_phase{phase='Running'}))"
          }
        ]
      },
      {
        "name": "memoryUsage",
        "datasource": "prometheus",
        "value_type": "double",
        "kubernetes_object": "container",
        "aggregation_functions": [
          {
            "function": "avg",
            "query": "avg by(container, namespace) (avg_over_time(container_memory_working_set_bytes{container!='', container!='POD',namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"}[1d]))"
          },
          {
            "function": "min",
            "query": "min by(container, namespace) (min_over_time(container_memory_working_set_bytes{container!='', container!='POD',namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\" }[1d]))"
          },
          {
            "function": "max",
            "query": "max by(container, namespace) (max_over_time(container_memory_working_set_bytes{container!='', container!='POD',namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"}[1d]))"
          },
          {
            "function": "sum",
            "query": "sum by(container, namespace) (avg_over_time(container_memory_working_set_bytes{container!='', container!='POD',namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"}[1d]))"
          }
        ]
      },
      {
        "name": "memoryRSS",
        "datasource": "prometheus",
        "value_type": "double",
        "kubernetes_object": "container",
        "aggregation_functions": [
          {
            "function": "avg",
            "query": "avg by(container, namespace) (avg_over_time(container_memory_rss{container!='', container!='POD',namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"}[1d]))"
          },
          {
            "function": "min",
            "query": "min by(container, namespace) (min_over_time(container_memory_rss{container!='', container!='POD',namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"}[1d]))"
          },
          {
            "function": "max",
            "query": "max by(container, namespace) (max_over_time(container_memory_rss{container!='', container!='POD',namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"}[1d]))"
          },
          {
            "function": "sum",
            "query": "sum by(container, namespace) (avg_over_time(container_memory_rss{container!='', container!='POD',namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"}[1d]))"
          }
        ]
      },
     {
      "name" : "maxDate",
      "datasource": "prometheus",
      "value_type": "double",
      "kubernetes_object": "container",
      "aggregation_functions": [
         {
           "function": "max",
           "query": "last_over_time(container_cpu_usage_seconds_total{container!='', container!='POD', namespace=\"$NAMESPACE$\",container=\"$CONTAINER_NAME$\"}[1d])"
         }
      ]
     }
    ]
  }
}

